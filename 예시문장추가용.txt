{"question": "ë‚´ ê¸°ë¶„ì´ ì™œ ì•ˆ ì¢‹ì„ê¹Œ?", "options": ["ëª°ë¼", "ë‚˜ ë•Œë¬¸ì—?", "ë‹¹ê·¼ì´ ì©ì–´ì„œ"], "answer": "ë‚˜ ë•Œë¬¸ì—?"},

{"question": "^^?", "options": ["ë¯¸ì•ˆí•´ë¯¸ì•ˆí•´ë¯¸ì•ˆí•´ë¯¸ì•ˆí•´", "í•  ë§ ìˆìŒ ë§ë¡œ í•´", "í•˜í•˜í•˜!"], "answer": "ë¯¸ì•ˆí•´ë¯¸ì•ˆí•´ë¯¸ì•ˆí•´ë¯¸ì•ˆí•´"},

{"question": "ë‹¹ê·¼ ì¢‹ì•„í•´?", "options": ["ìš°ì›©", "ì•„ë‹ˆ", "ì‚¬ë‘í•´"], "answer": "ì•„ë‹ˆ"},

{"question": "ë‚´ê°€ ë­˜ë¡œ ë³´ì—¬?", "options": ["ìµœê³ ë¡œì‚¬ë‘ìŠ¤ëŸ½ê³ ì•„ë¦„ë‹¤ìš´í† ë¼", "ì“°ë ˆê¸°ë´‰íˆ¬", "ê·¸ë˜í”½ë©ì–´ë¦¬"], "answer": "ìµœê³ ë¡œì‚¬ë‘ìŠ¤ëŸ½ê³ ì•„ë¦„ë‹¤ìš´í† "},








console.log("ğŸ° ë°©í•´ê³µì‘ í€´ì¦ˆ ì‘ë™ ì¤‘...");

const overlay = document.getElementById("quizOverlay");
const qText = document.getElementById("quizQuestion");
const qOptions = document.getElementById("quizOptions");

let quizCache = [];
let inQuiz = false;

// ============================
// ğŸ§© 1ï¸âƒ£ í€´ì¦ˆ ë¯¸ë¦¬ ë¡œë“œ
// ============================
async function preloadQuizzes() {
  const currentLevel = window.currentLevel || 1; // ì „ì—­ level ê°€ì ¸ì˜¤ê¸°
  try {
    const res = await fetch(`/api/get_quiz_batch?level=${currentLevel}&n=5`);
    quizCache = await res.json();
    console.log(`ë ˆë²¨ ${currentLevel} í€´ì¦ˆ ë¯¸ë¦¬ ë¡œë“œ ì™„ë£Œ:`, quizCache);
  } catch (err) {
    console.error("âŒ í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨:", err);
  }
}

// ============================
// ğŸ§© 2ï¸âƒ£ ë°©í•´ê³µì‘ ì‹¤í–‰ í•¨ìˆ˜
// ============================
async function triggerQuiz() {
  if (inQuiz) return;
  if (quiz.type === "chat" || window.currentLevel < 5) {
  const randomLine = generateRandomChat();
  qText.textContent = randomLine;

  // ğŸ§  ì„œë²„ì— ì €ì¥ (ë‚˜ì¤‘ì— í€´ì¦ˆì— ì“°ì„)
  try {
    await fetch("/api/save_chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: randomLine })
    });
    console.log("ğŸ’¾ ì¼ìƒ ëŒ€í™” ì €ì¥:", randomLine);
  } catch (err) {
    console.error("ëŒ€í™” ì €ì¥ ì‹¤íŒ¨:", err);
  }

  document.getElementById("bunny-bubble").innerText = randomLine;
  overlay.classList.add("hidden");
  inQuiz = false;
  return;
}

  // âœ… ì¼ë°˜ í€´ì¦ˆ ë²„íŠ¼ ìƒì„±
  quiz.options.forEach(opt => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.onclick = async () => {
      try {
        const res = await fetch("/api/check_answer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ answer: opt, correct: quiz.answer }),
        });
        const result = await res.json();

        qOptions.innerHTML = "";
        if (result.correct) {
          qText.textContent = "âœ… ì •ë‹µì´ì—ìš”!";
          quizCorrect();
        } else {
          qText.textContent = "âŒ í‹€ë ¸ì–´ìš”! ë‹¤ì‹œ ì‹œë„!";
          quizWrong();
        }

        setTimeout(() => {
          overlay.classList.add("hidden");
          inQuiz = false;
        }, 1000);
      } catch (err) {
        console.error("ì •ë‹µ í™•ì¸ ì‹¤íŒ¨:", err);
      }
    };
    qOptions.appendChild(btn);
  });

  overlay.classList.remove("hidden");
}

// ============================
// ğŸ§© 3ï¸âƒ£ ì¼ì • í™•ë¥ ë¡œ í€´ì¦ˆ ë“±ì¥
// ============================
function maybeTriggerQuiz() {
  if (Math.random() < 0.4 && !inQuiz) triggerQuiz();
}

// ============================
// ğŸ§© 4ï¸âƒ£ ê²Œì„ ë£¨í”„ ì—°ê²°
// ============================
setInterval(() => {
  if (!inQuiz) maybeTriggerQuiz();
}, 3000);

// ============================
// ğŸ§© 5ï¸âƒ£ ì‹œì‘ ì‹œ í€´ì¦ˆ ìºì‹œ ë¡œë“œ
// ============================
window.addEventListener("DOMContentLoaded", preloadQuizzes);

// ============================
// âš™ï¸ ë ˆë²¨/ì ìˆ˜ ì „ì—­ ë³€ìˆ˜ (game.jsì™€ ê³µìœ )
// ============================
window.currentLevel = window.currentLevel || 1;

// ============================
// ğŸ§  ì •ë‹µ / ì˜¤ë‹µ ë°˜ì‘
// ============================
function quizCorrect() {
  score += 50;
  combo++;
  if (combo >= 3) {
    level++;
    combo = 0;
    window.currentLevel = level; // âœ… ë ˆë²¨ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById("bunny-img").src = "/static/bunny_surprised.PNG";
    document.getElementById("bunny-bubble").innerText = `ë‚œì´ë„ ìƒìŠ¹! Level ${level}`;
  } else {
    document.getElementById("bunny-img").src = "/static/bunny_happy.PNG";
    document.getElementById("bunny-bubble").innerText = "ì •ë‹µì´ì—ìš”! ğŸ’–";
  }
}

function quizWrong() {
  combo = 0;
  document.getElementById("bunny-img").src = "/static/bunny_angry.PNG";
  document.getElementById("bunny-bubble").innerText = "ì•—! ì˜¤ë‹µì´ì—ìš” ğŸ˜¤";
  const originalSpeed = dropInterval;
  dropInterval = dropInterval / 2;
  setTimeout(() => (dropInterval = originalSpeed), 5000);
}

function generateRandomChat() {
  const foods = ["ì˜¤ë¯€ë¼ì´ìŠ¤","ê°ˆë¹„", "ìš°ìœ¡ë©´", "ì–‘ë…ì¹˜í‚¨", "ì˜¤ì§•ì–´íšŒ",
     "ê´‘ì–´íšŒ", "ëˆê°€ìŠ¤", "ëˆì¹´ì¸ ", "ëƒ‰ë©´", "ë¶ˆë‹­ë³¶ìœ¼ë©´", "ë¡œì œë–¡ë³¶ì´",
      "ê³„ë€ì°œ", "ë¶€ì¹¨ê°œ", "ì´ˆë°¥", "í”¼ì", "ë¼ë©´", "ì¹˜í‚¨", "ìƒëŸ¬ë“œ", "ìŠ¤íŒŒê²Œí‹°",
    "ë©˜ë³´ìƒ¤", "ìƒˆìš°íŠ€ê¹€ìš°ë™", "ë³¶ìŒë°¥", "í•œìš°A++", "ë“±ì‹¬ì¹´ì¸ ", "í† ë§ˆí† ì„¤íƒ•ë¬´ì¹¨",
  "íŒŒë‹­", "ë¬¸ì–´ìˆ™íšŒ", "ì “êµ­", "ê²Œêµ­ì§€", "ê¹€ë°¥", "ì§œíŒŒê²Œí‹°", "ì§¬ë½•", "ë‚ ë‹¬ê±€"];
  const hobbies = ["ëœ¨ê°œì§ˆ","ê±´ë‹´ì¡°ë¦½", "ìš”ë¦¬", "ì‘ê³¡", "ê²Œì„", "ì½”ë”©",
    "ëŸ°ë‹", "ìš´ë™", "ì¬ë´‰", "ë†ì‚¬", "ë†êµ¬", "ìˆ˜ì˜", "ë…ì„œ", "ì‚°ì±…", "ë‚šì‹œ", "ë…¸ë˜"];
  const moods = ["í–‰ë³µí•´", "ì‹ ë‚˜!", "ê·¸ëƒ¥ ì¡°ìš©íˆ ìˆê³  ì‹¶ì–´", "ê¸°ë¶„ ìµœê³ ì•¼~",
    "ì¢€ ì§€ë£¨í•˜ë„¤..", "í•˜ì•”...ì•—. í”¼ê³¤í•´ì„œ.", "..ì—‡! ë‚ ì”¨ ì—„ì²­ ì¢‹ë‹¤. í•˜ëŠ˜ì´ ì—„ì²­ ì˜ˆë»!", 
    " ì ì‹œë§Œ...ì˜¤?! ë¹„ì˜¨ë‹¤. ë‚œ ì‚¬ì‹¤ ë¹„ ì˜¤ëŠ” ë‚ ì„ ì¢‹ì•„í•´. ë¶€ì¹¨ê°œ ë•¡ê¸°ì–ì•„.", "ì‰¬ê³ ì‹¶ë„¤",
    "ê·¸ë˜.", "ì¡°ê¸ˆ ì„¤ë Œë‹¤.", "ëˆ„ì›Œì„œ ìê³  ì‹¶ì–´~", "ê·¸ëŸ­ì €ëŸ­ í–‰ë³µí•œ ê²ƒ ê°™ì•„"
  ];

  const type = Math.random();
  if (type < 0.4) {
    return `ë‚˜ëŠ” ${foods[Math.floor(Math.random() * foods.length)]}ë¥¼ ì¢‹ì•„í•´! ğŸ´`;
  } else if (type < 0.8) {
    return `ìš”ì¦˜ ${hobbies[Math.floor(Math.random() * hobbies.length)]}ì— ë¹ ì¡Œì–´ ğŸ°`;
  } else {
    return `ì˜¤ëŠ˜ì€ ${moods[Math.floor(Math.random() * moods.length)]} ğŸ˜Š`;
  }
}
